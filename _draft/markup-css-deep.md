# markup, css deep-dive

## block-formatting context가 만들어지는 경우

block-formatting context
: 웹 페이지의 블록 레벨 요소를 렌더링하는데 사용되는 CSS의 비주얼 서식 모델 중 하나다.

1. float
2. position(static, relative 제외) : absolute
3. display(table-cell, inline-block 등)
4. block-level-box면서 overflow를 갖는 경우


> overflow:hidden 은 float옆에서 새로운 기준점을 만든다.
주의할 점은 floagt 옆의 block요소에 별도의 width 값없이 overflow:hidden 주는 경우에
부모 요소에서 float해제가 필요하다.

## 렌더링

HTML, CSS, JS를 해석하여 화면에 보여주는 것을 렌더링이라고 한다.
렌더링은 웹브라우저가 가지는 핵심 기능 중 하나다.

### 렌더링 과정의 이해

HTML과 CSS가 화면에 표시되기까지 총 5가지 과정을 거친다.

1. HTML을 파싱하여 DOM을 만든다
2. CSS를 파싱하여 CSSOM을 만든다
3. DOM과 CSSOM을 결합하여 렌더트리를 만든다.
4. 렌더트리의 각 노드의 위치 및 크기, 형태를 계산한다. (이를 Layout 이라고 한다.)
5. 화면에 노드를 그린다. (Paint)

자세히 알아보자.

#### DOM 생성

텍스트로 작성된 HTML, CSS를 웹브라우저가 다루기 쉬운 `트리 형태의 객체모델로 변환`하게 된다.
이 변환 과정을 parsing이라고 한다.

- 먼저, 서버에서 전송된 HTML은 TEXT형태의 Bytes Code다.
- 파서는 이 byte코드를 지정된 인코딩 방식에 따라 문자화 한다.
- 이 문자를 의미있는 단위로 구분하는 토큰화를 진행한다.
- 다시 토큰을 조합해서 노드를 만든다.
- 마지막으로 **노드들의 부모-자식 관계에 따라 트리로 연결**하면 DOM이 완성된다.

CSS도 HTML과 동일하게 트리 형태로 파싱한다.
이 때, 상속할 수 있는 스타일을 먼저 자식노드에 반복 적용 후, 자식 노드들의 개별 스타일을 적용하여 최종 스타일을 완성하다.


#### 렌더트리 생성

**웹브라우저는 DOM과 CSSOM을 결합하여 렌더트리를 만든다.**

- DOM트리의 루트에서 시작해서 화면에 그려야할 노드를 하나씩 탐색한다.
  - 화면에 출력되지 않는 노드들은 렌더트리에 반영되지 않는다.
  - CSS로 감춘 노드 역시 렌더트리에서 제외


#### 레이아웃과 페인팅

**렌더트리에 있는 노드의 스타일에 따라 Box Model을 만들고 화면에 배치한다.**
이 과정을 `Layout` 또는 `Reflow`라고 한다.

Layout 과정을 통해 정해진 노드의 위치, 크기, 형태를 가지고 **실제 화면에 표시**한다.
이 과정을 `Paint`라고 한다.

> 간혹 화면의 크기가 작거나 viewport 변경, 또는 이미지의 크기 변경 등
Layout정보를 그대로 화면에 표시할 수 없는 경우에는 다시 실제 화면 상에 맞춰 변환하여 그린다.
이것을 `Rasterize Paint`라고 한다.


## 정리

렌더링 중에 DOM과 CSSOM을 변경하게 되면 웹브라우저는 화면에 다시 그려야 하는 부분을 알아내기 위해
같은 과정을 또 반복한다. 따라서, 화면에 빠르게 첫화면을 표시하기 위해 parsing부터 첫번째 Paint까지
걸리는 시간을 최소화하는 것을 크리티컬 렌더링 패스 최적화라고 한다.

이 최적화를 통해서 사용자 인터랙션 시간을 최소화할 수 있다.


## 렌더링 성능 최적화

### 1. CSS는 위로 JS는 아래로

HTML 파싱 도중 CSS나 JS를 만나면 DOM생성을 멈춘다.
CSSOM을 작성해야 렌더트리를 만들어 화면에 표시 가능하고, JS에서 DOM구조를 변경할 수 있기 때문이다.
따라서, 렌더링시 반드시 필요한 CSS는 초기에 다운로드 및 파싱할 수 있도록 head에 작성하는 것이 좋다.

JS는 DOM에 영향을 주는 부분은 위로, 이벤트 처리는 문서의 끝에 하는게 좋다. DOM에 영향을 주지 않는 JS는
렌더트리에는 영향을 주지 않기 때문이다. 비록 JS 실행하는 동안 DOM생성은 멈추지만 DOM이 변경되어 렌더트리 다시 만드는 일은 없다. 
